## Getting started with azure-multiple-cluster environment

The `azure-multiple-cluster` environment deploys three different clusters (similar to that deployed with the `azure-simple` environment) each of which are behind an [Azure Traffic Manager](https://azure.microsoft.com/en-us/services/traffic-manager/).  The Traffic Manager is then configured with rules for routing traffic to one of the three clusters.

This deployment creates the following:

- [Three different AKS clusters](#cluster-deployment)
- [A Public IP Address](#public-ip-address) for each cluster
- [Azure Traffic Manager](#traffic-manager-deployment)

When deploying the `azure-multiple-cluster` environment, one has the option to deploy using a Service Principal that has `Owner` privileges on the Azure Subscription or to use one that does not.  This is controled using the variable `service_principal_is_owner`.  When set to `1`, `Owner` privileges are required and the Public IP for each AKS cluster will be deployed into the Resource Group specified for each of the clusters (see [Cluster Deployment](#cluster-deployment)).  When set to `0`, the Public IP for each AKS cluster will be provisioned in the Resource Group generated by the AKS Cluster Provisioner.  In this second case, `Owner` privileges are not required.  The reason for these options is based on allowing the AKS Cluster to make use of the Public IP, which is discussed [here](https://docs.microsoft.com/en-us/azure/aks/static-ip).  The default behavior is to deploy the cluster requiring `Owner` privileges

To deploy the `azure-multiple-cluster` environment, one follows the [common steps](../../azure/) with the following modifications:

- `resource_group` and `resource_group_location` are not used, as each component below references it's own Resource Group and Location
- `service_principal_is_owner` must be configured to `0` if the service principal doesn't have `Owner` permissions on the subscription
- Cluster specific configuration outlined in [Cluster Deployment](#cluster-deployment)
- Traffic Manager specific configuration outlined in [Traffic Manager Deployment](#traffic-manager-deployment)

Additional environment-wide variables that can be configured are in [aks-variables.tf](./aks-variables.tf).

### Cluster Deployment

The `azure-multiple-cluster` enviornment assumes three regional clusters are deployed with their configurations and deployment scripts named accordingly - `aks-eastus`, `aks-westus`, `aks-centralus`.  

Each cluster (east, west, central) has three cluster-specific configuration variables:

- `<region>-resource_group_name`: The resource group name where the cluster will be deployed
- `<region>-resource_group_location`: The location of the resource group and where the cluster will be deployed
- `<region>-gitops-path`: This value is optional.  If configured, it should be configured for each of the three regions.  It specifies a path within the GitOps repo from which [Flux](../../common/flux) will pull manifests from.

Variables for each cluster can be found for [east](./aks-eastus-variables.tf), [west](./aks-westus-variables.tf),[central](./aks-centralus-variables.tf).

As part of cluster deployment, if one is deploying with `service_principal_is_owner=1`, in addition to creating the cluster, an Azure Role Assignment for each AKS cluster Service Principal will be created with `Network Contributor` role on the appropriate Public IP resource. 

As mentioned in [common steps](../../azure/), the deployment of an AKS cluster generates the corresponding Kubernetes Configuration file for that cluster and places it in the `output_directory`.  For the `azure-multiple-cluster` environment, the location where configuration files are written is the same.  However, each cluster has a cluster specific name for the output file, which is of the format `<cluster-resource-group-location>-<cluster-name>_kube_config`.  So for a three cluster deployment, there will be three unique Kubernetes configuration files.

### Public IP Address

In order to route traffic through Traffic Manager to each AKS cluster, this deployment creates a Public IP Address resource for each cluster.  Depending on the configuration of `service_principal_is_owner`, the Public IP Address will either be provisioned in `<region>-resource-group-name` or within the Resource Group created by the Azure AKS Provider.

In addition to creating the Public IP Address for each cluster, a Traffic Manager Rule will be created for each Public IP Address so that the Traffic Manager knows about and can route traffic accordingly.

### Traffic Manager Deployment

Azure Traffic Manager allows inbound traffic to be routed to one or more resources based upon a set of rules.  For this environment, the Traffic Manager is set up to route traffic to each of the deployed AKS Clusters based off of the Public IP Address associated with each cluster.

The configuration variables required for Traffic Manager are:

- `traffic_manager_profile_name`: The profile name (general name) of the Traffic Manager to be provisioned.
- `traffic_manager_dns_name`: External DNS name for the traffic manager.
- `traffic_manager_resource_group_name`: The name of the Resource Group Traffic Manager will be deployed to.
- `traffic_manager_resource_group_location`: The location where Traffic Manager will be deployed.